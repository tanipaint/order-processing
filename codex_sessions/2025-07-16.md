## セッションログ (2025-07-16)

**User**: Interactivity & Events 設定は、このアプリケーションをどこかのサーバーに上げないと成り立ちませんか？
**Assistant**: はい。そのとおりです。

Slack のインタラクティブ機能（ボタン押下イベントなど）を正しく動作させるには、Slack 側からコールバックリクエストを受け取れる公開エンドポイントが必要です。
ローカルで動かしているだけでは Slack から届いたリクエストを受け取れないため、Interactivity & Events の設定は成立しません。

---

**User**: では、ngrokでローカル公開を選択します。設定を案内してください。
**Assistant**: 以下の手順で ngrok を使ってローカルの FastAPI/Slack エンドポイントを公開し、Slack App の Interactivity & Events を動作させましょう。

## 1. ngrok のインストール
1. ngrok のダウンロードページ（https://ngrok.com/download ）からお使いの OS 向けバイナリを取得
2. 実行ファイルをパスの通った場所（例：/usr/local/bin/ngrok）に置く
3. （オプション）ngrok authtoken <YOUR_AUTH_TOKEN> でアカウントを紐付ける

```bash
# Homebrew (macOS) 例
brew install ngrok/ngrok/ngrok

# あるいはダウンロードして
mv ~/Downloads/ngrok /usr/local/bin/
chmod +x /usr/local/bin/ngrok
```

## 2. ローカルサーバーを起動
```bash
docker-compose up -d app
# または
# uvicorn src.main:app --reload
```

## 3. ngrok でトンネルを張る
```bash
ngrok http 8000
```

※ 出力される Forwarding の HTTPS URL (例: https://abcd1234.ngrok.io) をコピーしてください。

## 4. Slack App 管理画面の設定
### 4.1 Interactivity & Shortcuts
1. Slack App 管理画面 → Interactivity & Shortcuts
2. Interactivity をオン
3. Request URL に https://<NGROK_URL>/slack/events を設定

### 4.2 Event Subscriptions (必要に応じて)
1. Slack App 管理画面 → Event Subscriptions
2. Enable Events をオン
3. Request URL に https://<NGROK_URL>/slack/events を設定
4. Subscribe to Bot Events で必要なイベントを追加

## 5. 動作確認
1. App を再インストール
2. チャネルで通知メッセージをポストし、承認ボタンをクリック
3. FastAPI/ngrok のログにイベント受信が流れれば成功

---

**User**: 4.2 Event Subscriptions についてどのように追加すれば良いか詳細をお願いします。
**Assistant**: Event Subscriptions は、Slack Bot に対して特定のイベントを購読してプッシュ通知を受け取りたい場合に設定する機能です。

以下のステップで設定してください。

## 1. Slack App 管理画面で Event Subscriptions を選択
1. https://api.slack.com/apps で対象 App を選択
2. 左メニューの Event Subscriptions をクリック

## 2. Request URL の登録
1. Enable Events を ON
2. Request URL に https://<NGROK_URL>/slack/events を設定し Save Changes
3. Verified ステータスを確認

## 3. Bot イベントの追加
1. Subscribe to Bot Events セクションで必要なイベントを追加

例:
- message.channels (チャンネルで Bot が言及されたとき)
- app_mention (@your-bot でメンションされたとき)
- reaction_added (リアクションが付与されたとき)

※ ボタンアクション (block_actions) はインタラクティビティ設定で処理するため追加不要です。

## 4. App の再インストール
OAuth & Permissions → Reinstall App to Workspace を実行

以上で Event Subscriptions の設定が完了し、購読したイベントを受信できるようになります。

---

**User**: ここまでのセッションログを保存してください。
**Assistant**: このファイルに上記内容を保存しました。
